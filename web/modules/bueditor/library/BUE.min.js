(function(g,m,k,p){'use strict';var b=m.BUE=m.BUE||{editors:{},popups:{},buttonDefinitions:{},buttonRegistry:{},fileBrowsers:{},builders:{},protos:{},i18n:{},counter:0};g.fn.BUE=function(a){var c,d,e;if("get"===a)return(d=this[0])?b.editorOf(d):!1;e="detach"===a?b.detach:b.attach;for(c=0;d=this[c];c++)e(d,a);return this};b.attach=function(a,c){var d=b.editorOf(a);!d&&c&&(c.customButtons&&(b.defineRegisteredButtons(),b.addButtonDefinitions(c.customButtons),c.customButtons=null),d=new b.Editor(a,c));
return d};b.detach=function(a){(a=b.editorOf(a))&&a.destroy();return a};b.getEditor=function(a){return b.editors[a]};b.getPopup=function(a){return b.popups[a]};b.getButtonDefinition=function(a){b.definedRB||b.defineRegisteredButtons();return b.buttonDefinitions[a]};b.addButtonDefinition=function(a){if(a.id){var c=a.code?"code":a.template?"template":!1;c&&"string"===typeof a[c]&&"js:"===a[c].substr(0,3)&&(a[c]=new Function("E","$",a[c].substr(3)));return b.buttonDefinitions[a.id]=a}};b.addButtonDefinitions=
function(a){if(a)for(var c in a)b.addButtonDefinition(a[c])};b.registerButtons=function(a,c){b.buttonRegistry[a]=c;b.definedRB&&b.addButtonDefinitions(c())};b.defineRegisteredButtons=function(){if(!b.definedRB){var a,c=b.buttonRegistry;b.definedRB=!0;for(a in c)b.addButtonDefinitions(c[a]())}};b.t=function(a,c){var d,e,q,f=b.i18nHandlers;a=b.i18n[a]||a||"";if(c)for(d in f||(f=b.i18nHandlers={"@":b.plain,"%":b.emplain}),c){e=c[d];if(q=f[d.charAt(0)])e=q(e);a=a.replace(d,e)}return a};b.extend=function(a){var c,
b,e,f=arguments;a||(a={});for(c=1;c<f.length;c++)if(e=f[c])for(b in e)a[b]=e[b];return a};b.regesc=function(a){return a.replace(/([\\\^\$\*\+\?\.\(\)\[\]\{\}\|\:\-])/g,"\\$1")};b.delayError=function(a){setTimeout(function(){throw a;})};b.focusEl=function(a){try{a.focus()}catch(c){}};b.createForm=function(a,c){var d;d=b.formHtmlObj(a);c||(c={});b.extendAttr(d.attributes,c.attributes);d=b.buildCreateEl(d);d.onsubmit=b.eFormSubmit;g(d).data("options",c);return d};b.formHtmlObj=function(a){var c,d,e,
f,h="",g="",l=[];for(c=0;d=a[c];c++)if(f=b.fieldHtml(d),d.isAction)g+=f;else if("hidden"===d.type)h+=f;else{for(e=d;e.getnext;)if(e=a[++c])f+=b.fieldHtml(e);else break;l.push(b.fieldRowHtml(d,f))}g&&(g='<div class="bue-form-actions">'+g+"</div>");l=b.fieldRowsHtml(l);return{tag:"form",html:l+g+h,attributes:{"class":"bue-form"}}};b.eFormSubmit=function(){try{var a,c,d,e,f,h,n;for(a=0;c=this.elements[a];a++)if(c.getAttribute("required")){if(!c.value)return b.setFieldError(c),b.focusEl(c),!1;b.unsetFieldError(c)}if(d=
g(this).data("options")){if(h=b.popupOf(this))n=h.Editor;if((e=d.validate)&&!e.call(d,this,h,n))return!1;(f=d.submit)&&f.call(d,this,h,n)}}catch(l){b.delayError(l)}return!1};b.createDialogForm=function(a,c){c=b.extend({addButtons:!0,submitClose:!0},c);c.addButtons&&(a.push(b.getSubmitField(c.stitle)),a.push(b.getCancelField(c.ctitle)));c.dialogSubmit=c.submit;c.submit=b.submitDialogForm;return b.createForm(a,c)};b.submitDialogForm=function(a,c,b){this.submitClose&&c.close();return this.dialogSubmit.call(this,
a,c,b)};b.createTagForm=function(a,c,d){d=b.extend({tag:a},d);d.attributes=b.extendAttr({"class":"bue-tag-form","data-tag":a},d.attributes);d.tagSubmit=d.submit;d.submit=b.submitTagForm;c=g.map(c,b.processTagField);return b.createDialogForm(c,d)};b.submitTagForm=function(a,c,d){var e=b.tagFormToHtmlObj(a);if(a=this.tagSubmit)return a.call(this,e,c,d);d.insertHtmlObj(e)};b.tagFormToHtmlObj=function(a){var c,b,e,f={tag:a.getAttribute("data-tag"),attributes:{}};for(c=0;b=a.elements[c];c++)if(e=b.getAttribute("data-attr-name"))if("checkbox"!==
b.type||b.checked)b=b.value||b.getAttribute("data-empty-value"),"html"===e?f.html=b||"":f.attributes[e]=b;return f};b.processTagField=function(a){a=b.processField(a);a.attributes["data-attr-name"]===p&&(a.attributes["data-attr-name"]=a.name);return a};b.processField=function(a){if(!a.processed){var c,d=a.type;d||(d=a.type="text");c={name:a.name,id:"bue-field-"+ ++b.counter,"class":"bue-field form-"+d};a.required&&(c.required="required",c["class"]+=" required");null!=a.empty&&(c["data-empty-value"]=
a.empty);if("submit"===d||"button"===d)c["class"]+=" button",a.primary&&(c["class"]+=" button--primary"),a.isAction===p&&(a.isAction=!0);a.attributes=b.extendAttr(c,a.attributes);a.processed=!0}return a};b.fieldHtml=function(a){a.processed||(a=b.processField(a));var c,d,e,f=a.type,h="",g=a.attributes;switch(f){case "select":if(d=a.options)for(c in d)e={value:c},c==a.value&&(e.selected="selected"),h+=b.html("option",d[c],e);break;case "textarea":h=a.value;break;default:g=b.extend({type:f,value:a.value},
g),f="input"}return(a.prefix||"")+b.html(f,h,g)+(a.suffix||"")};b.fieldRowHtml=function(a,c){var d={"class":"bue-field-row "+a.type+"-row"};a.required&&(d["class"]+=" required-row");null!=a.title&&(c=b.html("label",a.title,{"for":a.attributes.id})+c);return b.html("div",c,d)};b.fieldRowsHtml=function(a){return b.html("div",a.join(""),{"class":"bue-field-rows"})};b.setFieldError=function(a){g(a).addClass("error").parent().addClass("error-parent")};b.unsetFieldError=function(a){g(a).removeClass("error").parent().removeClass("error-parent")};
b.getSubmitField=function(a){return{name:"op",type:"submit",value:a||b.t("OK"),primary:!0}};b.getCancelField=function(a){return{name:"cancel",type:"button",value:a||b.t("Cancel"),attributes:{onclick:"BUE.popupOf(this).close()"}}};b.browseButton=function(a,c,d,e){return b.html("button",e||b.t("Browse"),{type:"button","class":"button bue-browse-button",onclick:"return BUE.eBrowseButtonClick.apply(this, arguments);","data-browser-name":a,"data-input-name":c,"data-browse-type":d})};b.eBrowseButtonClick=
function(a){a=this.form;var c=a.elements[this.getAttribute("data-input-name")],d=this.getAttribute("data-browse-type"),e=b.fileBrowsers[this.getAttribute("data-browser-name")];c&&e&&e.call&&e.call(e,c,d,b.popupOf(a).Editor);return!1};b.html=function(a,c,d){var e,f,h;"object"===typeof a&&(c=a.html,d=a.attributes,a=a.tag);if(!a)return c||"";h="<"+a;if(d)for(e in d)f=d[e],null!=f&&(h+=" "+e+'="'+(""+f).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")+'"');if(d=b.selfClosing(a))h+=" /";
h+=">"+(c||"");d||(h+="</"+a+">");return h};b.selfClosing=function(a){return/^(area|br|col|embed|hr|img|input|keygen|param|source|track|wbr)$/.test(a)};b.createEl=function(a){var c=b._div;c||(c=b._div=k.createElement("div"));c.innerHTML=a;a=c.firstChild;c.removeChild(a);return a};b.removeEl=function(a){var c=a.parentNode;if(c)return c.removeChild(a)};b.buildCreateEl=function(a,c,d){return b.createEl(b.html(a,c,d))};b.extendAttr=function(a,c){if(c){var d=a["class"];b.extend(a,c);d&&"class"in c&&(a["class"]=
d+(c["class"]?" "+c["class"]:""))}return a};b.parseHtml=function(a,c){var d,e,f,h,g,l;if(l=a.match(new RegExp("^<("+(c||"[a-z][a-z0-9]*")+")([^>]*)>(?:([\\s\\S]*)</\\1>)?$")))if(c=l[1],h=l[3],null!=h||b.selfClosing(c)){g={};if(l=l[2].match(/[\w-]+="[^"]*"/g))for(d=0;d<l.length;d++)e=l[d].split("="),f=e.shift(),g[f]=e.join("=").replace(/"/g,"");return{tag:c,attributes:g,html:h}}};b.plain=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};
b.emplain=function(a){return'<em class="plain">'+b.plain(a)+"</em>"};b.createTagChooserEl=function(a,c){var d,e,f,h,n,l,k;c=b.extend({wrapEach:"div",wrapAll:"div",applyTag:!0,onclick:b.eTagChooserLinkClick},c);d=b.html("a","",{href:"#","class":"choice-link"});d=c.wrapEach?b.html(c.wrapEach,d,{"class":"choice"}):d;n=b.createEl(d);h=b.buildCreateEl(c.wrapAll,"",{"class":"bue-tag-chooser"+(c.cname?" "+c.cname:"")});for(d=0;e=a[d];d++)k=n.cloneNode(!0),l=k.firstChild||k,f={tag:e[0],attributes:e[2]},g(l).data("htmlObj",
f).click(c.onclick).html(c.applyTag?b.html.apply(this,e):e[1]),h.appendChild(k);return h};b.eTagChooserLinkClick=function(a){var c=g(this).data("htmlObj"),d=b.popupOf(this);d.close();d.Editor.insertHtmlObj(c);a.preventDefault()};b.protos.event={bind:function(a,c){var b=this.events,e=b[a];e||(e=b[a]={});e[""+c]=c},unbind:function(a,c){var b=this.events,e=b[a];e&&(c?delete e[""+c]:delete b[a])},trigger:function(a){var c,b,e,f=this.events[a];if(f)for(c in e=Array.prototype.slice.call(arguments,1),e.unshift(this),
f)(b=f[c])&&b.apply&&b.apply(this,e)}};b.protos.state={setState:function(a){this[a]||(this[a]=!0,g(this.el).addClass(a))},unsetState:function(a){this[a]&&(this[a]=!1,g(this.el).removeClass(a))},toggleState:function(a,c){null==c&&(c=!this[a]);this[c?"setState":"unsetState"](a)}};b.extendProto=function(a){var c,d=b.protos,e=arguments;for(c=1;c<e.length;c++)b.extend(a,d[e[c]]);return a};b.protos.shortcut={addShortcut:function(a,c){this.shortcuts[a.toUpperCase()]=c},getShortcut:function(a){return this.shortcuts[a.toUpperCase()]},
removeShortcut:function(a){delete this.shortcuts[a.toUpperCase()]},fireShortcut:function(a){if(a=this.getShortcut(a)){if(a.click)return a.click(),!0;if(a.call)return!1!==a.call(a,this)}}};b.eBuildShortcut=function(a){var c,d=a.keyCode,e="";d&&(c=b.getKeySymbols(d))&&(a.ctrlKey&&(e+="CTRL+"),a.altKey&&(e+="ALT+"),a.shiftKey&&(e+="SHIFT+"),e+=c);return e};b.getKeySymbols=function(a){var c,d=b.keySymbols;if(!d){d=b.keySymbols={8:"BACKSPACE",9:"TAB",13:"ENTER",27:"ESC",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",
40:"DOWN"};for(c=0;10>c;c++)d[48+c]=""+c;for(c=65;91>c;c++)d[c]=String.fromCharCode(c);for(c=1;13>c;c++)d[111+c]="F"+c}return 0 in arguments?d[a]:d};b.setSelectionRange=function(a,c,b){a.setSelectionRange?a.setSelectionRange(c,b):a.createTextRange&&(a=a.createTextRange(),a.collapse(),a.moveEnd("character",b),a.moveStart("character",c),a.select())};b.getSelectionRange=function(a){var c=a.selectionStart,b=a.selectionEnd;if("number"!==typeof c){var c=b=0,e,f,h=k.selection;if(h&&h.createRange)try{a.focus();
e=h.createRange();f=e.duplicate();for(f.moveToElementText(a);0>f.compareEndPoints("StartToStart",e);c++)f.moveStart("character",1);for(b=c;0>f.compareEndPoints("StartToEnd",e);b++)f.moveStart("character",1)}catch(g){}}return{start:c,end:b}};b.getTextareaValue=function(a){return b.text(a.value)};b.setTextareaValue=function(a,c){var b=a.scrollTop;a.value=c;a.scrollTop=b;clearTimeout(a.bueChangeTimeout);a.bueChangeTimeout=setTimeout(function(){g(a).change();a=null},250)};b.ieMode=!(k.createElement("textarea").setSelectionRange||
!k.selection||!k.selection.createRange);b.text=b.ieMode?function(a){return(""+a).replace(/\r\n/g,"\n")}:function(a){return""+a};b.Button=function(a){this.construct(a)};var f=b.extendProto(b.Button.prototype,"state");f.construct=function(a){a&&(b.extend(this,a),this.createEl())};f.destroy=function(){this.remove();g(this.el).remove();delete this.el};f.createEl=function(){var a=this.el;a||(a=this.el=b.createEl(b.buttonHtml(this)),a.onclick=b.eButtonClick,a.onmousedown=b.eButtonMousedown,a.bueBid=this.id);
return a};f.toggleDisabled=function(a){this.toggleState("disabled",a)};f.togglePressed=function(a){this.toggleState("pressed",a)};f.remove=function(){var a=this.Editor;a&&a.removeButton(this)};f.fire=function(){var a=this.Editor;a&&a.fireButton(this)};b.eButtonClick=function(a){a=b.buttonOf(this);a.disabled||a.fire();return!1};b.eButtonMousedown=function(){var a=b.buttonOf(this);a.setState("active");g(k).one("mouseup",function(){a.unsetState("active");a=null});return!1};b.buttonHtml=function(a){var c,
d=b.buttonHtmlCache;d||(d=b.buttonHtmlCache={});c=d[a.id];return null!=c?c:d[a.id]=b.html(b.buttonHtmlObj(a))};b.buttonHtmlObj=function(a){var c=a.label||"",b=a.text||"",e=a.cname,f=a.shortcut;a={type:"button",tabindex:"-1","class":"bue-button bue-button--"+a.id,title:a.tooltip||c,"aria-label":c};e&&(-1!=e.indexOf("ficon-")&&(a["class"]+=" has-ficon"),a["class"]+=" "+e);b&&(a["class"]+=" has-text");f&&(a.title+=" ("+f+")");return{tag:"button",attributes:a,html:b}};b.buttonOf=function(a){var c=b.editorOf(a);
return c?c.buttons[a.bueBid]:!1};b.History=function(a){this.construct(a)};f=b.History.prototype;f.construct=function(a){b.extend(this,b.getHistoryDefaults(),a.settings.history);this.states=[];this.current=-1;this.Editor=a};f.destroy=function(){this.states=this.Editor=null};f.save=function(a){var b,d,e=this.Editor;if(a||!this.locked){this.locked=!0;for(this.delayUnlock();this.states[this.current+1];)this.states.pop();b=e.getContent();d=this.states;a=d.length;if(!a||b!==d[a-1].value)return a==this.limit&&
(d.shift(),a--),this.current=a,d[a]={value:b,scrollTop:e.getTextarea().scrollTop,range:e.getRange()}}};f.undo=function(){var a=this.states.length;if(a)return this.current==a-1&&this.save(!0),this.goto(this.current-1)};f.redo=function(){return this.goto(this.current+1)};f.goto=function(a){var b,d=this.Editor;if(b=this.states[a])this.locked=!0,d.setContent(b.value),d.setRange(b.range),d.getTextarea().scrollTop=b.scrollTop,this.current=a,this.locked=!1;return b};f.delayUnlock=function(){var a=this;clearTimeout(a.unlockTimer);
a.unlockTimer=setTimeout(function(){a.locked=!1;a=null},a.period)};f.handleKeyup=function(a){var b=a.keyCode,d=this.keys;a.ctrlKey&&(d=d.ctrl);d&&d[b]&&this.save()};b.getHistoryDefaults=function(a){return{limit:100,period:1E3,keys:{8:1,13:1,32:1,46:1,188:1,190:1,ctrl:{86:1,88:1}}}};b.Popup=function(a,b,d){this.construct(a,b,d)};f=b.extendProto(b.Popup.prototype,"event","state");f.construct=function(a,c,d){var e=d&&d.type;this.autoFocus=!0;"dialog"===e?this.withOverlay=!0:"quick"===e&&(this.autoClose=
this.noHeader=!0);b.extend(this,d);this.no=++b.counter;this.id="bue-popup-"+this.no;b.popups[this.id]=this;this.events={};this.createEl();this.setTitle(a);this.setContent(c)};f.destroy=function(){this.remove();g(this.el).remove();this.unbind();this.el=this.titleEl=this.contentEl=this.overlayEl=null;delete b.popups[this.id]};f.createEl=function(){var a,c,d,e;e=this.id;d=e+"-title";var f=e+"-content";a=this.el=b.createEl('<div class="bue-popup" role="dialog" tabindex="0"><div class="bue-popup-head"></div><div class="bue-popup-body"></div></div>');
a.id=e;a.setAttribute("aria-labelledby",d);a.setAttribute("aria-describedby",f);a.onkeydown=b.ePopupKeydown;a.buePid=e;if(e=this.type)a.className+=" type--"+e;if(e=this.name)a.className+=" name--"+e;if(e=this.cname)a.className+=" "+e;e=a.firstChild;e.onmousedown=b.ePopupHeadMousedown;this.noHeader&&(e.style.display="none");c=b.createEl('<a href="#" class="bue-popup-close" role="button"></a>');c.onclick=b.ePopupCloseClick;c.title=b.t("Close");e.appendChild(c);c=this.titleEl=b.createEl('<div class="bue-popup-title"></div>');
c.id=d;e.appendChild(c);d=this.contentEl=b.createEl('<div class="bue-popup-content"></div>');d.id=f;a.children[1].appendChild(d)};f.open=function(a){var c=this.el;this.on||(c.parentElement||k.body.appendChild(c),c.style.zIndex=b.maxZ(c)+2,this.withOverlay&&this.addOverlay(),this.setState("on"),this.setPosition(a),this.autoFocus&&this.focus(),this.autoClose&&this.setAutoClose(),this.trigger("open"));return this};f.close=function(){this.on&&(this.autoClose&&this.resetAutoClose(),this.unsetState("on"),
this.removeOverlay(),this.restoreFocus(),this.trigger("close"));return this};f.setTitle=function(a){null!=a&&g(this.titleEl).html(a)};f.setContent=function(a){null!=a&&g(this.contentEl).html(a)};f.setCss=function(a){g(this.el).css(a)};f.setPosition=function(a){a?this.setCss(a):this.el.style.top||this.Editor&&this.setCss(this.Editor.defaultPopupPosition(this))};f.focus=function(){var a;a=(a=this.getForm())&&g(a.elements).filter(":visible")[0]||g("a",this.contentEl).filter(":visible")[0]||this.el;this.restoreFocusEl=
k.activeElement;b.focusEl(a);if(a=this.Editor)a.preventFocus=!0};f.restoreFocus=function(){var a,c,d;if(d=this.restoreFocusEl)this.restoreFocusEl=null,c=b.popupOf(d),a=this.Editor,!a||c&&c.on?b.focusEl(d):a.focus()};f.setAutoClose=function(){g(k).bind("mousedown.buepopupac"+this.no,{pid:this.id},b.ePopupDocMousedown)};f.resetAutoClose=function(){g(k).unbind(".buepopupac"+this.no)};f.getForm=function(){return g("form",this.contentEl)[0]};f.addOverlay=function(){var a,c=this.el,d=this.overlayEl;d||
(d=this.overlayEl=b.createEl('<div class="bue-popup-overlay"></div>'),d.onmousedown=b.ePopupOverlayMousedown);if(a=c.parentNode)d.style.zIndex=(1*c.style.zIndex||1)-1,a.insertBefore(d,c)};f.removeOverlay=function(){var a=this.overlayEl;a&&b.removeEl(a)};f.remove=function(){this.close();var a=this.Editor;a&&a.removePopup(this)};b.ePopupKeydown=function(a){if(27==(a||m.event).keyCode)return b.popupOf(this).close(),!1};b.ePopupCloseClick=function(a){b.popupOf(this).close();return!1};b.ePopupHeadMousedown=
function(a){a=g.event.fix(a||m.event);var c=b.popupOf(this).el,d=g(c).offset();d.el=c;d.X=a.pageX;d.Y=a.pageY;g(k).bind("mousemove",d,b.ePopupHeadDrag).bind("mouseup",b.ePopupHeadDrop);return!1};b.ePopupHeadDrag=function(a){var b=a.data;g(b.el).css({left:b.left+a.pageX-b.X,top:b.top+a.pageY-b.Y});return!1};b.ePopupHeadDrop=function(a){g(k).unbind("mousemove",b.ePopupHeadDrag).unbind("mouseup",b.ePopupHeadDrop)};b.ePopupOverlayMousedown=function(a){return!1};b.ePopupDocMousedown=function(a){var c=
b.getPopup(a.data.pid);c&&c!==b.popupOf(a.target)&&c.close()};b.popupOf=function(a){return(a=g(a).closest(".bue-popup")[0])?b.getPopup(a.buePid):!1};b.maxZ=function(a,b){var d,e,f=0,h=(b||k.body).children;for(d=0;e=h[d];d++)e.offsetWidth&&e!==a&&(e=1*g(e).css("z-index"))&&e>f&&(f=e);return f};b.Editor=function(a,b){this.construct(a,b)};f=b.extendProto(b.Editor.prototype,"state","event","shortcut");f.construct=function(a,c){this.id="bue-"+(a.id||++b.counter);b.editors[this.id]=this;this.events={};
this.shortcuts={};this.settings=b.extend({},c);this.textarea=a;b.runEditorBuilders(this);this.createEl();this.textarea=null;this.controlTextarea(a);this.trigger("ready")};f.destroy=function(){this.el&&(this.trigger("destroy"),this.restoreTextarea(),g(this.el).remove(),this.el=this.toolbarEl=this.textareaWrapperEl=this.settings=this.shortcuts=this.events=null,this===b.active&&(b.active=null),delete b.editors[this.id])};f.createEl=function(){var a,c,d,e=this.el;d=this.settings;a=d.cname;if(!e){e=this.el=
k.createElement("div");e.id=this.id;e.className="bue"+(a?" "+a:"");a=this.toolbarEl=b.createEl('<div class="bue-toolbar" role="toolbar"></div>');a.onkeydown=b.eToolbarKeydown;a.onmousedown=b.eToolbarMousedown;a.bueEid=this.id;e.appendChild(a);a=this.textareaWrapperEl=b.createEl('<div class="bue-textarea-wrapper"></div>');a.onmousedown=b.eTwMousedown;a.bueEid=this.id;e.appendChild(a);if(d=d.toolbar)for(c=0;c<d.length;c++)this.addButton(d[c]);for(c in this.buttons){this.buttons[c].el.tabIndex=0;break}}return e};
f.focus=function(){b.focusEl(this.textarea)};f.setContent=function(a){this.history.save();b.setTextareaValue(this.textarea,a)};f.getContent=function(){return b.getTextareaValue(this.textarea)};f.addContent=function(a,b){var d=this.getContent();d&&b&&(d+=b);return this.setContent(d+a)};f.getRange=function(){var a=this.storedRange;return a?b.extend({},a):b.getSelectionRange(this.textarea)};f.setRange=function(a,c,d,e){"object"===typeof a&&(c=a.end,a=a.start);null==c||c<a?c=a:d&&("start"===d?c=a:a=c);
e&&(a+=e,c+=e);b.setSelectionRange(this.textarea,a,c);this.storedRange&&(this.storedRange={start:a,end:c})};f.getSelection=function(){var a=this.getRange();return this.getContent().substring(a.start,a.end)};f.setSelection=function(a,c){var d=this.getContent(),e=this.getRange(),f=e.start;a=b.text(a);this.setContent(d.substr(0,f)+a+d.substr(e.end));return this.setRange(f,f+a.length,c)};f.wrapSelection=function(a,c,d){var e=this.getContent(),f=this.getRange(),h=f.start,f=f.end;a=b.text(a);c=b.text(c);
this.setContent(e.substr(0,h)+a+e.substring(h,f)+c+e.substr(f));return this.setRange(h,f,d,a.length)};f.wrapLines=function(a,c,d,e){var f=this.getSelection().replace(/\r\n|\r/g,"\n"),h=b.regesc,g,l;if(!f)return this.wrapSelection(a+c,d+e);g=new RegExp("^"+h(a+c)+"([\\s\\S]*)"+h(d+e)+"$");a=(l=f.match(g))?l[1].replace(new RegExp(h(d)+"\n"+h(c),"g"),"\n"):a+c+f.replace(/\n/g,d+"\n"+c)+d+e;return this.setSelection(a)};f.tagLines=function(a,b,d){return this.wrapLines(b?"<"+b+">\n":"",(d===p?"  ":d)+"<"+
a+">","</"+a+">",b?"\n</"+b+">":"")};f.toggleTag=function(a,b,d){return this.insertHtmlObj({tag:a,html:this.getSelection(),attributes:b},d,!0)};f.insertHtmlObj=function(a,c,d){var e=this.getSelection(),f=a.tag,h=e&&b.parseHtml(e);if(h&&h.tag===f){if(d)return this.setSelection(h.html,c);a={tag:f,html:null==a.html||a.html===e?h.html:a.html,attributes:b.extend(h.attributes,a.attributes)}}else if(!b.selfClosing(f)&&!a.html)return a=b.html(f,"",a.attributes),this.wrapSelection(a.substr(0,a.length-f.length-
3),"</"+f+">",c);return this.setSelection(b.html(a),c)};f.browseButton=function(a,c,d){var e=this.settings;if((e=e[c+"Browser"]||e.fileBrowser)&&b.fileBrowsers[e])return b.browseButton(e,a,c,d)};b.eToolbarKeydown=function(a){var c,d,e;c=g.event.fix(a||m.event);a=c.keyCode;if(!(c.ctrlKey||c.shiftKey||c.altKey||37!==a&&39!==a)){d=g(".bue-button",this).filter(":visible");if(e=d.length)c=d.index(k.activeElement),d.eq((e+c+a-38)%e).focus();return!1}if(9!==a&&13!==a&&32!==a)return b.eFireShortcut.call(this,
c)};b.eToolbarMousedown=function(a){this===b.eTarget(a)&&b.editorOf(this).focus();return!1};b.eTwMousedown=function(a){if(this===b.eTarget(a))return b.editorOf(this).focus(),!1};b.eFireShortcut=function(a){var c;if((a=b.eBuildShortcut(a))&&(c=b.editorOf(this))&&c.fireShortcut(a))return!1};b.eTarget=function(a){a||(a=m.event);return a.target||a.srcElement};b.editorOf=function(a){return a.bueEid?b.getEditor(a.bueEid):!1};b.runEditorBuilders=function(a){b.buildEditorPopups(a);b.buildEditorButtons(a);
b.buildEditorPreview(a);b.buildEditorHistory(a);b.buildEditorAc(a);b.buildEditorIndent(a);for(var c in b.builders)b.builders[c](a)};f.posSelection=f.getRange;f.makeSelection=f.setRange;f.replaceSelection=f.setSelection;f.tagSelection=f.wrapSelection;b.buildEditorAc=function(a){a.ac={};a.bind("destroy",b.destroyEditorAc);a.bind("controlTextarea",b.acControlTextarea);a.settings.acTags&&a.addAc(">",b.acHtmlTags)};b.destroyEditorAc=function(a){delete a.ac};b.acControlTextarea=function(a,c){g(c).bind("keypress.bue",
b.eAcTextareaKeypress)};b.eAcTextareaKeypress=function(a){if(!a.isDefaultPrevented()){var c=b.editorOf(this);a=String.fromCharCode(a.which);return!1!==c.fireAc(a)}};b.acHtmlTags=function(a){var c,d=a.getRange().start;a=a.getContent().substr(0,d);var e=a.lastIndexOf("<");if(-1!=e&&"/"!==a.charAt(d-1)&&(c=a.substr(e+1).match(/^([a-z][a-z0-9]*)(?:\s[^>]*)?$/))&&!b.selfClosing(c[1]))return"</"+c[1]+">"};f.addAc=function(a,b){this.ac[a]=b};f.getAc=function(a){return this.ac[a]};f.removeAc=function(a){delete this.ac[a]};
f.fireAc=function(a){var b=this.getAc(a);b&&(b.call&&(b=b.call(b,this,a)),"string"===typeof b&&this.setSelection(b,"start"));return b};b.buildEditorButtons=function(a){a.buttons={};a.bind("destroy",b.destroyEditorButtons)};b.destroyEditorButtons=function(a){for(var b in a.buttons)a.buttons[b].destroy();delete a.buttons};f.addButton=function(a){var c;"string"===typeof a&&(a=b.getButtonDefinition(a));if(a)if(a.code)a.id&&!this.getButton(a.id)&&this.appendButton(new b.Button(a));else if(c=a.template){if(c.call)try{c=
c.call(a,this,g)}catch(d){c=!1,b.delayError(d)}c&&g(this.toolbarEl).append(c)}};f.appendButton=function(a){var b;a.remove();this.buttons[a.id]=a;this.toolbarEl.appendChild(a.el);(b=a.shortcut)&&this.addShortcut(b,a.el);a.el.bueEid=this.id;a.Editor=this};f.removeButton=function(a){var c,d=this.buttons;"string"===typeof a&&(a=this.getButton(a));a&&a.Editor===this&&((c=a.shortcut)&&this.getShortcut(c)===a.el&&this.removeShortcut(c),delete d[a.id],a===this.lastFiredButton&&delete this.lastFiredButton,
delete a.Editor,a.el.bueEid=null,b.removeEl(a.el))};f.getButton=function(a){return this.buttons[a]};f.fireButton=function(a){var c,d;"string"===typeof a&&(a=this.getButton(a));if(a){delete this.preventFocus;if(c=a.code)if(this.lastFiredButton=a,"string"===typeof c)a=c.split("|"),2==a.length?this.wrapSelection(a[0],a[1]):this.setSelection(c,"end");else try{d=c.call(a,this,g)}catch(e){b.delayError(e)}this.preventFocus||this.focus()}return d};f.toggleButtonsDisabled=function(a,b){var d,e=this.buttons;
null==b&&(b=this.lastFiredButton);this.toggleState("buttonsDisabled",a);a=this.buttonsDisabled;for(d in e)e[d]!==b&&e[d].toggleDisabled(a);b&&b.togglePressed(a)};b.buildEditorHistory=function(a){a.history=new b.History(a);a.bind("destroy",b.destroyEditorHistory);a.addShortcut("Ctrl+Z",b.editorUndo);a.addShortcut("Ctrl+Y",b.editorRedo);a.addShortcut("Ctrl+Shift+Z",b.editorRedo);a.bind("controlTextarea",b.historyControlTextarea)};b.destroyEditorHistory=function(a){a.history.destroy();delete a.history};
b.historyControlTextarea=function(a,c){g(c).bind("keyup.bue",b.eHistoryTextareaKeyup).one("focus.bue",b.eHistoryTextareaFocus)};b.eHistoryTextareaKeyup=function(a){b.editorOf(this).history.handleKeyup(a)};b.eHistoryTextareaFocus=function(a){a=b.editorOf(this).history;-1==a.current&&a.save()};b.editorUndo=function(a){a.undo()};b.editorRedo=function(a){a.redo()};f.undo=function(){return this.history.undo()};f.redo=function(){return this.history.redo()};b.buildEditorIndent=function(a){a.settings.indent&&
(a.addShortcut("TAB",b.editorIndent),a.addShortcut("Shift+TAB",b.editorUnindent),a.addShortcut("ENTER",b.editorAutoindent),a.addShortcut("Ctrl+Alt+TAB",b.editorToggleIndent))};b.editorIndent=function(a){return b.editorIndentCommon(a,"indent")};b.editorUnindent=function(a){return b.editorIndentCommon(a,"unindent")};b.editorAutoindent=function(a){return b.editorIndentCommon(a,"autoindent")};b.editorIndentCommon=function(a,b){var d=a.settings;if(!d.indent)return!1;a[b](d.indentStr||"  ")};b.editorToggleIndent=
function(a){a=a.settings;a.indent=!a.indent};f.indent=function(a){var b=this.getSelection();if(b&&-1!=b.indexOf("\n")){var d=this.getRange(),e=this.getContent(),f=d.start,d=d.end,b=b.split("\n"),h=e.substr(0,f).lastIndexOf("\n")+1,g=a.length;this.setContent(e.substr(0,h)+a+e.substring(h,f)+b.join("\n"+a)+e.substr(d));this.setRange(f==h?f:f+g,d+b.length*g)}else this.wrapSelection(a,"")};f.unindent=function(a){var c=this.getContent(),d=this.getRange(),e=d.start,d=d.end,f=c.substr(0,e).lastIndexOf("\n")+
1,g=c.substring(f,d),k,l=g.split("\n"),m=[];k=new RegExp("^"+b.regesc(a.charAt(0))+"{1,"+a.length+"}");for(a=0;a<l.length;a++)m[a]=l[a].replace(k,"");k=m.join("\n");a=k.length;a!==g.length&&(this.setContent(c.substr(0,f)+k+c.substr(d)),this.setRange(Math.max(f,e+m[0].length-l[0].length),f+a))};f.autoindent=function(a){var c,d=this.getContent(),e=this.getRange().start,f=d.substr(0,e).lastIndexOf("\n")+1,g="\n";e!=f&&(c=d.substr(f).match(new RegExp("^("+b.regesc(a.charAt(0))+"+)")))&&(g+=c[1]);this.setSelection(g,
"end")};b.buildEditorPopups=function(a){a.popups={};a.bind("destroy",b.destroyEditorPopups)};b.destroyEditorPopups=function(a){for(var b in a.popups)a.popups[b].destroy();delete a.popups};f.createPopup=function(a,c,d,e){var f=this.popups[a];f||(e=b.extend({name:a,Editor:this},e),f=this.popups[a]=new b.Popup(c,d,e));return f};f.getPopup=function(a){return this.popups[a]};f.removePopup=function(a){"string"===typeof a&&(a=this.getPopup(a));a&&a.Editor===this&&(a.close(),delete this.popups[a.name],delete a.Editor,
b.removeEl(a.el))};f.createDialog=function(a,c,d,e){e=b.extend({type:"dialog"},e);return this.createPopup(a,c,d,e)};f.tagDialog=function(a,b,d){d&&d.ignoreSelection||this.populateTagFields(a,b);return this.createTagDialog(a,b,d).open()};f.createTagDialog=function(a,c,d){d="string"===typeof d?{title:d}:d||{};var e=d.name||a+"-tag-dialog",e=this.getPopup(e)||this.createDialog(e,null,null,{tag:a});e.setTitle(d.title||b.t("Tag editor - @tag",{"@tag":a.toUpperCase()}));e.setContent(b.createTagForm(a,c,
d));return e};f.getTagDialog=function(a){return this.getPopup(a+"-tag-dialog")};f.tagChooser=function(a,c){var d=this.getPopup("tag-chooser");d||(d=this.createPopup("tag-chooser",null,null,{type:"quick"}));d.setContent(b.createTagChooserEl(a,c));return d.open()};f.defaultPopupPosition=function(a){var b,d,e;b=this.lastFiredButton;if(!b)return g(this.textarea).offset();d=b.el;b=g(d).offset();e=a.el.offsetWidth||50;a=b.left-e/2+d.offsetWidth/2;b=b.top+d.offsetHeight;d=a+e-(m.innerWidth||k.documentElement.clientWidth);
0<d&&(a-=d);return{left:Math.max(10,a),top:b}};f.populateTagFields=function(a,c){b.populateTagFieldsBySelection(a,c,this.getSelection())};b.populateTagFieldsBySelection=function(a,c,d){if(d){var e={html:d};if(a=b.parseHtml(d,a))e=a.attributes,e.html=a.html||"";for(d=0;a=c[d];d++)null!=e[a.name]&&(a.value=e[a.name])}};b.buildEditorPreview=function(a){a.bind("destroy",b.destroyEditorPreview)};b.destroyEditorPreview=function(a){a.hidePreview();delete a.previewEl};f.togglePreview=function(a){return this.previewing?
this.hidePreview():this.showPreview(a)};f.showPreview=function(a){this.setState("previewing");return this.setPreviewContent(a)};f.hidePreview=function(){var a;this.unsetState("previewing");if(a=this.previewXHR)delete this.previewXHR,a.abort&&a.abort()};f.setPreviewContent=function(a){var b=this.getPreviewEl();g(b).html(a||"");return b};f.getPreviewEl=function(){var a=this.previewEl;a||(a=this.previewEl=b.createEl('<div class="bue-preview"></div>'),this.textareaWrapperEl.appendChild(a));return a};
f.controlTextarea=function(a){var c,d=this.textarea;a&&a!==d&&(d&&this.restoreTextarea(),(c=a.parentNode)&&c.insertBefore(this.el,a),this.textareaWrapperEl.appendChild(a),a.className+=" bue-textarea",a.bueEid=this.id,this.textarea=a,g(a).bind("focus.bue",b.eTextareaFocus).bind("blur.bue",b.eTextareaBlur).bind("keydown.bue",b.eTextareaKeydown).bind("keypress.bue",b.eTextareaKeypress),"onbeforeactivate"in a&&!m.atob&&g(a).bind("beforeactivate.bue",b.eTextareaBeforeactivate).bind("beforedeactivate.bue",
b.eTextareaBeforedeactivate),this.trigger("controlTextarea",a,d))};f.restoreTextarea=function(){var a=this.textarea;a&&(this.trigger("restoreTextarea",a),g(a).unbind(".bue").removeClass("bue-textarea").insertAfter(this.el),a.bueEid=this.textarea=this.storedRange=null)};f.getTextarea=function(){return this.textarea};b.eTextareaFocus=function(a){a=b.editorOf(this);b.active=a;a.setState("focused")};b.eTextareaBlur=function(a){b.editorOf(this).unsetState("focused")};b.eTextareaKeydown=function(a){return b.eFireShortcut.call(this,
a)};b.eTextareaBeforeactivate=function(a){a=b.editorOf(this);var c=a.storedRange;c&&(a.storedRange=null,a.setRange(c))};b.eTextareaBeforedeactivate=function(a){a=b.editorOf(this);a.storedRange=a.getRange()};b.registerButtons("BUE",function(){for(var a={"-":{id:"-",template:'<span class="bue-separator"></span>'},"/":{id:"/",template:'<span class="bue-newline"></span>'},bold:{id:"bold",label:b.t("Bold"),cname:"ficon-bold",code:"<strong>|</strong>",shortcut:"Ctrl+B"},italic:{id:"italic",label:b.t("Italic"),
cname:"ficon-italic",code:"<em>|</em>",shortcut:"Ctrl+I"},underline:{id:"underline",label:b.t("Underline"),cname:"ficon-underline",code:"<ins>|</ins>",shortcut:"Ctrl+U"},strike:{id:"strike",label:b.t("Strikethrough"),cname:"ficon-strike",code:"<del>|</del>"},quote:{id:"quote",label:b.t("Quote"),cname:"ficon-quote",code:"<blockquote>|</blockquote>"},code:{id:"code",label:b.t("Code"),cname:"ficon-code",code:"<code>|</code>"},ul:{id:"ul",label:b.t("Bulleted list"),cname:"ficon-ul",code:b.editorInsertUL},
ol:{id:"ol",label:b.t("Numbered list"),cname:"ficon-ol",code:b.editorInsertOL},link:{id:"link",label:b.t("Link"),cname:"ficon-link",code:b.editorInsertLink},image:{id:"image",label:b.t("Image"),cname:"ficon-image",code:b.editorInsertImage},undo:{id:"undo",label:b.t("Undo"),cname:"ficon-undo",shortcut:"Ctrl+Z",code:b.editorUndo},redo:{id:"redo",label:b.t("Redo"),cname:"ficon-redo",shortcut:"Ctrl+Y",code:b.editorRedo}},c,d=1;7>d;d++)c="h"+d,a[c]={id:c,label:b.t("Heading !n",{"!n":d}),text:"H"+d,code:"<"+
c+">|</"+c+">"};return a});b.editorInsertUL=function(a){a.tagLines("li","ul")};b.editorInsertOL=function(a){a.tagLines("li","ol")};b.editorInsertLink=function(a){a.tagDialog("a",[{name:"href",title:b.t("URL"),required:!0,suffix:a.browseButton("href","link")},{name:"html",title:b.t("Text")}],b.t("Link"))};b.editorInsertImage=function(a){a.tagDialog("img",[{name:"src",title:b.t("URL"),required:!0,suffix:a.browseButton("src","image")},{name:"width",title:b.t("Width x Height"),suffix:" x ",getnext:!0,
attributes:{size:3}},{name:"height",attributes:{size:3}},{name:"alt",title:b.t("Alternative text"),empty:""}],b.t("Image"))}})(jQuery,window,document);
